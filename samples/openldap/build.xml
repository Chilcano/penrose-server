<!--
 Copyright (c) 2000-2005, Identyx Corporation.
 All rights reserved.
-->
<project name="back-java" default="install">

    <description>Java Backend for OpenLDAP</description>

    <property name="cygwin.home" value="c:/cygwin"/>

    <property name="openldap.src" value="${cygwin.home}/usr/src/openldap-2.2.26"/>
    <property name="openldap.patch" value="openldap-2.2.26.patch"/>

    <target name="init">
        <condition property="isWindows">
            <os family="windows"/>
        </condition>
        <condition property="isUnix">
            <os family="unix"/>
        </condition>
    </target>

    <target name="install" depends="init">
        <antcall target="install-linux"/>
        <antcall target="install-windows"/>
    </target>

    <target name="install-linux" if="isLinux">

        <property name="patch" value="/usr/bin/patch"/>
        <echo message="Patching files in ${openldap.src} using ${openldap.patch}:" />
        <exec executable="${patch}">
            <arg line="-p1"/>
            <arg line="-i ${basedir}/${openldap.patch}"/>
            <arg line="-d ${openldap.src}"/>
        </exec>
        
    </target>

    <target name="install-windows" if="isWindows">

        <property name="patch" value="${cygwin.home}/bin/patch.exe"/>
        <echo message="Patching files in ${openldap.src} using ${openldap.patch}:" />
        <exec executable="${patch}">
            <arg line="-p1"/>
            <arg line="-i ${basedir}/${openldap.patch}"/>
            <arg line="-d ${openldap.src}"/>
        </exec>

        <copy todir="${openldap.src}/servers/slapd/back-java" overwrite="true">
            <fileset dir="back-java" />
        </copy>

        <property name="dlltool" value="${cygwin.home}/bin/dlltool.exe"/>
        <echo message="Calling ${dlltool}:" />
        <echo message=" --input-def ${openldap.src}/servers/slapd/back-java/win32/jvm.def" />
        <echo message=" --output-lib ${openldap.src}/servers/slapd/back-java/win32/libjvm.dll.a" />
        <exec executable="${dlltool}">
            <arg line="--input-def ${openldap.src}/servers/slapd/back-java/win32/jvm.def"/>
            <arg line="--output-lib ${openldap.src}/servers/slapd/back-java/win32/libjvm.dll.a"/>
            <arg line="--kill-at"/>
            <arg line="--dllname jvm.dll"/>
        </exec>

    </target>

</project>
