<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE directory PUBLIC
  "-//Penrose/DTD Directory ${product.specification}//EN"
  "http://penrose.safehaus.org/dtd/directory.dtd">

<directory>

  <entry dn="${nssSuffix}">
    <oc>organizationalUnit</oc>
    <oc>nisDomainObject</oc>
    <at name="ou" rdn="true">
      <constant>${repository.name}</constant>
    </at>
    <at name="nisDomain">
      <constant>${nisDomain}</constant>
    </at>
    <aci subject="self">
      <permission>rws</permission>
    </aci>
    <aci>
      <target>ATTRIBUTES</target>
      <attributes>userPassword</attributes>
      <action>deny</action>
      <permission>rs</permission>
    </aci>
    <aci>
      <permission>rs</permission>
    </aci>
  </entry>

  <entry dn="ou=Users,${nssSuffix}">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Users</constant>
    </at>
  </entry>

  <entry dn="uid=...,ou=Users,${nssSuffix}">
    <entry-class>org.safehaus.penrose.federation.directory.FederationEntry</entry-class>
    <mapping-name>users</mapping-name>
    <at name="uid" rdn="true">
      <variable>n.uid</variable>
    </at>
    <source alias="n">
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>users</source-name>
      <mapping-name>users_to_nis_users</mapping-name>
    </source>
    <source alias="g">
      <partition-name>global</partition-name>
      <source-name>users</source-name>
      <mapping-name>users_to_global_users</mapping-name>
      <field name="${linkingGlobalAttribute}">
        <variable>n.${linkingLocalAttribute}</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Groups,${nssSuffix}">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Groups</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Groups,${nssSuffix}">
    <entry-class>org.safehaus.penrose.federation.directory.FederationEntry</entry-class>
    <mapping-name>nss_groups</mapping-name>
    <at name="cn" rdn="true">
      <variable>n.primaryKey.cn</variable>
    </at>
    <source alias="n">
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>groups</source-name>
      <mapping-name>groups_to_nis_groups</mapping-name>
      <field name="cn" primaryKey="true">
        <variable>rdn.cn</variable>
      </field>
    </source>
    <source alias="g">
      <partition-name>global</partition-name>
      <source-name>groups</source-name>
      <mapping-name>groups_to_global_groups</mapping-name>
      <field name="${linkingGlobalAttribute}">
        <variable>n.${linkingLocalAttribute}</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Hosts,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>hosts</source-name>
    </source>
  </entry>

  <entry dn="ou=Services,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>services</source-name>
    </source>
  </entry>

  <entry dn="ou=RPCs,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>rpcs</source-name>
    </source>
  </entry>

  <entry dn="ou=NetIDs,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>netids</source-name>
    </source>
  </entry>

  <entry dn="ou=Protocols,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>protocols</source-name>
    </source>
  </entry>

  <entry dn="ou=Aliases,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>aliases</source-name>
    </source>
  </entry>

  <entry dn="ou=Netgroups,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>netgroups</source-name>
    </source>
  </entry>

  <entry dn="ou=Ethers,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>ethers</source-name>
    </source>
  </entry>

  <entry dn="ou=BootParams,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>bootparams</source-name>
    </source>
  </entry>

  <entry dn="ou=Networks,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <source>
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>networks</source-name>
    </source>
  </entry>

  <entry dn="ou=Automounts,${nssSuffix}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <at name="nisMapEntry">
      <expression foreach="a.nisMapEntry" var="nisMapEntry">
import org.safehaus.penrose.ldap.*;

if (!nisMapEntry.startsWith("ldap:")) return nisMapEntry;

int i = nisMapEntry.indexOf(' ', 5);

String name;
String info;

if (i &lt; 0) {
    name = nisMapEntry.substring(5);
    info = null;
} else {
    name = nisMapEntry.substring(5, i);
    info = nisMapEntry.substring(i+1);
}

DN dn = new DN(name);
DN newDn = dn.getPrefix("${nisSuffix}").append("${nssSuffix}");

return "ldap:"+newDn+(info == null ? "" : " "+info);
      </expression>
    </at>
    <source alias="a">
      <partition-name>${repository.name}_nis</partition-name>
      <source-name>automounts</source-name>
    </source>
  </entry>

</directory>
