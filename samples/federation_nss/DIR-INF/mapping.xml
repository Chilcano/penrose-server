<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapping PUBLIC
  "-//Penrose/DTD Mapping ${product.specification}//EN"
  "http://penrose.safehaus.org/dtd/mapping.dtd">

<mapping>

  <entry dn="${NSS_SUFFIX}">
    <oc>organizationalUnit</oc>
    <oc>nisDomainObject</oc>
    <at name="ou" rdn="true">
      <constant>${DOMAIN}</constant>
    </at>
    <at name="nisDomain">
      <constant>${NIS_DOMAIN}</constant>
    </at>
    <aci subject="self">
      <permission>rws</permission>
    </aci>
    <aci>
      <target>ATTRIBUTES</target>
      <attributes>userPassword</attributes>
      <action>deny</action>
      <permission>rs</permission>
    </aci>
    <aci>
      <permission>rs</permission>
    </aci>
  </entry>

  <entry dn="ou=Users,${NSS_SUFFIX}">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Users</constant>
    </at>
  </entry>

  <entry dn="uid=...,ou=Users,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.federation.directory.FederationEntry</entry-class>
    <oc>account</oc>
    <oc>posixAccount</oc>
    <oc>shadowAccount</oc>
    <at name="uid" rdn="true">
      <variable>n.uid</variable>
    </at>
    <at name="cn">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.cn != void &amp;&amp; n.cn != null
    &amp;&amp; !n.cn.equals("NULL")) {
    return n.cn;
}
return g.cn;
      </expression>
    </at>
    <at name="uidNumber">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.uidNumber != void &amp;&amp; n.uidNumber != null
    &amp;&amp; !n.uidNumber.equals("0")) {
    return n.uidNumber;
}
return g.uidNumber;
      </expression>
    </at>
    <at name="gidNumber">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.gidNumber != void &amp;&amp; n.gidNumber != null
    &amp;&amp; !n.gidNumber.equals("0")) {
    return n.gidNumber;
}
return g.gidNumber;
      </expression>
    </at>
    <at name="homeDirectory">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.homeDirectory != void &amp;&amp; n.homeDirectory != null
    &amp;&amp; !n.homeDirectory.equals("NULL")) {
    return n.homeDirectory;
}
return g.homeDirectory;
      </expression>
    </at>
    <at name="userPassword">
      <expression>
if (g != void &amp;&amp; g != null
    &amp;&amp; g.userPassword != void &amp;&amp; g.userPassword != null
    &amp;&amp; !g.userPassword.equals("NULL")) {
    return g.userPassword;
}
return n.userPassword;
      </expression>
    </at>
    <at name="loginShell">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.loginShell != void &amp;&amp; n.loginShell != null
    &amp;&amp; !n.loginShell.equals("NULL")) {
    return n.loginShell;
}
return g.loginShell;
      </expression>
    </at>
    <at name="gecos">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.gecos != void &amp;&amp; n.gecos != null
    &amp;&amp; !n.gecos.equals("NULL")) {
    return n.gecos;
}
return g.gecos;
      </expression>
    </at>
    <at name="description">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.description != void &amp;&amp; n.description != null
    &amp;&amp; !n.description.equals("NULL")) {
    return n.description;
}
return g.description;
      </expression>
    </at>
    <at name="shadowLastChange">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowLastChange != void &amp;&amp; n.shadowLastChange != null
    &amp;&amp; !n.shadowLastChange.equals("NULL")) {
    return n.shadowLastChange;
}
return g.shadowLastChange;
      </expression>
    </at>
    <at name="shadowMin">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowMin != void &amp;&amp; n.shadowMin != null
    &amp;&amp; !n.shadowMin.equals("NULL")) {
    return n.shadowMin;
}
return g.shadowMin;
      </expression>
    </at>
    <at name="shadowMax">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowMax != void &amp;&amp; n.shadowMax != null
    &amp;&amp; !n.shadowMax.equals("NULL")) {
    return n.shadowMax;
}
return g.shadowMax;
      </expression>
    </at>
    <at name="shadowWarning">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowWarning != void &amp;&amp; n.shadowWarning != null
    &amp;&amp; !n.shadowWarning.equals("NULL")) {
    return n.shadowWarning;
}
return g.shadowWarning;
      </expression>
    </at>
    <at name="shadowInactive">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowInactive != void &amp;&amp; n.shadowInactive != null
    &amp;&amp; !n.shadowInactive.equals("NULL")) {
    return n.shadowInactive;
}
return g.shadowInactive;
      </expression>
    </at>
    <at name="shadowExpire">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowExpire != void &amp;&amp; n.shadowExpire != null
    &amp;&amp; !n.shadowExpire.equals("NULL")) {
    return n.shadowExpire;
}
return g.shadowExpire;
      </expression>
    </at>
    <at name="shadowFlag">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.shadowFlag != void &amp;&amp; n.shadowFlag != null
    &amp;&amp; !n.shadowFlag.equals("NULL")) {
    return n.shadowFlag;
}
return g.shadowFlag;
      </expression>
    </at>
    <source name="n">
      <source-name>nis_users</source-name>
      <field name="uid">
        <variable>uid</variable>
      </field>
      <field name="cn">
        <variable>cn</variable>
      </field>
      <field name="uidNumber">
        <variable>uidNumber</variable>
      </field>
      <field name="gidNumber">
        <variable>gidNumber</variable>
      </field>
      <field name="homeDirectory">
        <variable>homeDirectory</variable>
      </field>
      <field name="userPassword">
        <variable>userPassword</variable>
      </field>
      <field name="loginShell">
        <variable>loginShell</variable>
      </field>
      <field name="gecos">
        <variable>gecos</variable>
      </field>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="shadowLastChange">
        <variable>shadowLastChange</variable>
      </field>
      <field name="shadowMin">
        <variable>shadowMin</variable>
      </field>
      <field name="shadowMax">
        <variable>shadowMax</variable>
      </field>
      <field name="shadowWarning">
        <variable>shadowWarning</variable>
      </field>
      <field name="shadowInactive">
        <variable>shadowInactive</variable>
      </field>
      <field name="shadowExpire">
        <variable>shadowExpire</variable>
      </field>
      <field name="shadowFlag">
        <variable>shadowFlag</variable>
      </field>
    </source>
    <source name="g">
      <source-name>global_users</source-name>
      <field name="seeAlso">
        <variable>n.dn</variable>
      </field>
      <field name="cn">
        <variable>cn</variable>
      </field>
      <field name="uidNumber">
        <variable>uidNumber</variable>
      </field>
      <field name="gidNumber">
        <variable>gidNumber</variable>
      </field>
      <field name="homeDirectory">
        <variable>homeDirectory</variable>
      </field>
      <field name="userPassword">
        <variable>userPassword</variable>
      </field>
      <field name="loginShell">
        <variable>loginShell</variable>
      </field>
      <field name="gecos">
        <variable>gecos</variable>
      </field>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="shadowLastChange">
        <variable>shadowLastChange</variable>
      </field>
      <field name="shadowMin">
        <variable>shadowMin</variable>
      </field>
      <field name="shadowMax">
        <variable>shadowMax</variable>
      </field>
      <field name="shadowWarning">
        <variable>shadowWarning</variable>
      </field>
      <field name="shadowInactive">
        <variable>shadowInactive</variable>
      </field>
      <field name="shadowExpire">
        <variable>shadowExpire</variable>
      </field>
      <field name="shadowFlag">
        <variable>shadowFlag</variable>
      </field>
    </source>
    <source name="a" search="ignore" bind="ignore">
      <source-name>ad_users</source-name>
      <field name="objectGuid">
        <variable>g.seeAlsoObjectGuid</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Groups,${NSS_SUFFIX}">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Groups</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Groups,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.federation.directory.FederationEntry</entry-class>
    <oc>posixGroup</oc>
    <at name="cn" rdn="true">
      <variable>n.primaryKey.cn</variable>
    </at>
    <field name="cn">
      <variable>n.cn</variable>
    </field>
    <at name="gidNumber">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.gidNumber != void &amp;&amp; n.gidNumber != null
    &amp;&amp; !n.gidNumber.equals("0")) {
    return n.gidNumber;
}
return g.gidNumber;
      </expression>
    </at>
    <at name="userPassword">
      <expression>
if (g != void &amp;&amp; g != null
    &amp;&amp; g.userPassword != void &amp;&amp; g.userPassword != null
    &amp;&amp; !g.userPassword.equals("NULL")) {
    return g.userPassword;
}
return n.userPassword;
      </expression>
    </at>
    <at name="memberUid">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; (n.memberUid == void || n.memberUid == null || !n.memberUid.equals("NULL"))) {
    return n.memberUid;
}
return g.memberUid;
      </expression>
    </at>
    <at name="description">
      <expression>
if (n != void &amp;&amp; n != null
    &amp;&amp; n.description != void &amp;&amp; n.description != null
    &amp;&amp; !n.description.equals("NULL")) {
    return n.description;
}
return g.description;
      </expression>
    </at>
    <source name="n">
      <source-name>nis_groups</source-name>
      <field name="cn" primaryKey="true">
        <variable>rdn.cn</variable>
      </field>
      <field name="cn">
        <variable>cn</variable>
      </field>
      <field name="gidNumber">
        <variable>gidNumber</variable>
      </field>
      <field name="userPassword">
        <variable>userPassword</variable>
      </field>
      <field name="memberUid">
        <variable>memberUid</variable>
      </field>
      <field name="description">
        <variable>description</variable>
      </field>
    </source>
    <source name="g">
      <source-name>global_groups</source-name>
      <field name="seeAlso">
        <variable>n.dn</variable>
      </field>
      <field name="cn">
        <variable>cn</variable>
      </field>
      <field name="gidNumber">
        <variable>gidNumber</variable>
      </field>
      <field name="userPassword">
        <variable>userPassword</variable>
      </field>
      <field name="memberUid">
        <variable>memberUid</variable>
      </field>
      <field name="description">
        <variable>description</variable>
      </field>
    </source>
    <source name="a" search="ignore" bind="ignore">
      <source-name>ad_groups</source-name>
      <field name="objectGuid">
        <variable>g.seeAlsoObjectGuid</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Hosts,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Hosts</constant>
    </at>
    <source>
      <source-name>nis_hosts</source-name>
    </source>
  </entry>

  <entry dn="ou=Services,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Services</constant>
    </at>
    <source>
      <source-name>nis_services</source-name>
    </source>
  </entry>

  <entry dn="ou=RPCs,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>RPCs</constant>
    </at>
    <source>
      <source-name>nis_rpcs</source-name>
    </source>
  </entry>

  <entry dn="ou=NetIDs,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>NetIDs</constant>
    </at>
    <source>
      <source-name>nis_netids</source-name>
    </source>
  </entry>

  <entry dn="ou=Protocols,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Protocols</constant>
    </at>
    <source>
      <source-name>nis_protocols</source-name>
    </source>
  </entry>

  <entry dn="ou=Aliases,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Aliases</constant>
    </at>
    <source>
      <source-name>nis_aliases</source-name>
    </source>
  </entry>

  <entry dn="ou=Netgroups,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Netgroups</constant>
    </at>
    <source>
      <source-name>nis_netgroups</source-name>
    </source>
  </entry>

  <entry dn="ou=Ethers,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Ethers</constant>
    </at>
    <source>
      <source-name>nis_ethers</source-name>
    </source>
  </entry>

  <entry dn="ou=BootParams,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>BootParams</constant>
    </at>
    <source>
      <source-name>nis_bootparams</source-name>
    </source>
  </entry>

  <entry dn="ou=Networks,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Networks</constant>
    </at>
    <source>
      <source-name>nis_networks</source-name>
    </source>
  </entry>

  <entry dn="ou=Automounts,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Automounts</constant>
    </at>
    <at name="nisMapEntry">
      <expression foreach="a.nisMapEntry" var="nisMapEntry">
import org.safehaus.penrose.ldap.*;

if (!nisMapEntry.startsWith("ldap:")) return nisMapEntry;

int i = nisMapEntry.indexOf(' ', 5);

String name;
String info;

if (i &lt; 0) {
    name = nisMapEntry.substring(5);
    info = null;
} else {
    name = nisMapEntry.substring(5, i);
    info = nisMapEntry.substring(i+1);
}

DN dn = new DN(name);
DN newDn = dn.getPrefix("${NIS_SUFFIX}").append("${NSS_SUFFIX}");

return "ldap:"+newDn+(info == null ? "" : " "+info);
      </expression>
    </at>
    <source name="a">
      <source-name>nis_automounts</source-name>
    </source>
  </entry>

  <entry dn="ou=Profile,${NSS_SUFFIX}">
    <entry-class>org.safehaus.penrose.directory.ProxyEntry</entry-class>
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Profile</constant>
    </at>
    <source>
      <source-name>profile</source-name>
    </source>
  </entry>

</mapping>
