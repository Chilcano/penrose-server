<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapping PUBLIC
  "-//Penrose/DTD Mapping ${product.specification}//EN"
  "http://penrose.safehaus.org/dtd/mapping.dtd">

<mapping>

  <entry dn="dc=Shop,dc=Example,dc=com">
    <oc>dcObject</oc>
    <oc>organization</oc>
    <at name="dc" rdn="true">
      <constant>Shop</constant>
    </at>
    <at name="o">
      <constant>Shop</constant>
    </at>
    <aci subject="self">
      <permission>rws</permission>
    </aci>
    <aci>
      <target>ATTRIBUTES</target>
      <attributes>userPassword</attributes>
      <action>deny</action>
      <permission>rs</permission>
    </aci>
    <aci>
      <permission>rs</permission>
    </aci>
  </entry>

  <entry dn="ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Products</constant>
    </at>
  </entry>

  <entry dn="ou=All Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>All Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=All Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="description">
      <variable>cat.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <at name="productId">
      <variable>products.id</variable>
    </at>
    <at name="categoryId">
      <variable>products.categoryId</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
      <field name="price">
        <variable>price</variable>
      </field>
      <field name="id">
        <variable>productId</variable>
      </field>
      <field name="categoryId">
        <variable>categoryId</variable>
      </field>
    </source>
    <source name="cat" readOnly="true">
      <source-name>categories</source-name>
      <field name="name">
        <variable>description</variable>
      </field>
    </source>
    <relationship>
      <expression>products.categoryId = cat.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Categories,cn=...,ou=All Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Categories</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Categories,cn=...,ou=All Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>category</oc>
    <at name="cn" rdn="true">
      <variable>categories.name</variable>
    </at>
    <at name="description">
      <variable>categories.description</variable>
    </at>
    <source name="categories">
      <source-name>categories</source-name>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <relationship>
      <expression>products.categoryId = categories.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Prices,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Prices</constant>
    </at>
  </entry>

  <entry dn="price=...,ou=Prices,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="price" rdn="true">
      <variable>products.price</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="price">
        <variable>price</variable>
      </field>
    </source>
  </entry>

  <entry dn="cn=...,price=...,ou=Prices,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products2.name</variable>
    </at>
    <at name="price">
      <variable>products2.price</variable>
    </at>
    <source name="products2">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <relationship>
      <expression>products2.price = products.price</expression>
    </relationship>
  </entry>
  <entry dn="ou=Price Ranges,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Price Ranges</constant>
    </at>
  </entry>
  <entry dn="price=...,ou=Price Ranges,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="price" rdn="true">
      <expression foreach="products.price" var="x">x+" or under"</expression>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="price">
        <expression>if (price == void || price == null) return;
int i = price.indexOf(" ");
if (i &lt; 0) return price;
return price.substring(0, i);</expression>
      </field>
    </source>
  </entry>

  <entry dn="cn=...,price=...,ou=Price Ranges,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products2.name</variable>
    </at>
    <at name="price">
      <variable>products2.price</variable>
    </at>
    <source name="products2">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <relationship>
      <expression>products2.price &lt;= products.price</expression>
    </relationship>
  </entry>

  <entry dn="ou=Expensive Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Expensive Products</constant>
    </at>
  </entry>
  <entry dn="cn=...,ou=Expensive Products,ou=Products,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
      <parameter>
        <param-name>filter</param-name>
        <param-value>(price&gt;=5.0)</param-value>
      </parameter>
    </source>
  </entry>

  <entry dn="ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Categories</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>category</oc>
    <at name="cn" rdn="true">
      <variable>categories.name</variable>
    </at>
    <at name="categoryId">
      <variable>categories.id</variable>
    </at>
    <at name="description">
      <variable>categories.description</variable>
    </at>
    <source name="categories">
      <source-name>categories</source-name>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="id">
        <variable>categoryId</variable>
      </field>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>All Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="description">
      <variable>categories.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <relationship>
      <expression>categories.id = products.categoryId</expression>
    </relationship>
  </entry>

  <entry dn="ou=Orders,cn=...,ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Orders</constant>
    </at>
  </entry>

  <entry dn="orderId=...,ou=Orders,cn=...,ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>order</oc>
    <at name="date">
      <variable>orders.orderDate</variable>
    </at>
    <at name="orderId" rdn="true">
      <variable>orders.id</variable>
    </at>
    <at name="uid">
      <variable>orders.customer</variable>
    </at>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="orders">
      <source-name>orders</source-name>
      <field name="customer">
        <variable>uid</variable>
      </field>
      <field name="id">
        <variable>orderId</variable>
      </field>
      <field name="orderDate">
        <variable>date</variable>
      </field>
    </source>
    <relationship>
      <expression>products.id = order_details.productId</expression>
    </relationship>
    <relationship>
      <expression>order_details.orderId = orders.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Customers,cn=...,ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Customers</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Customers,cn=...,ou=All Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>customer</oc>
    <at name="cn" rdn="true">
      <expression>
if (customers == void || customers == null) return null;
if (customers.firstName == void || customers.firstName == null) return null;
if (customers.lastName == void || customers.lastName == null) return null;
return customers.firstName+" "+customers.lastName;
    </expression>
    </at>
    <at name="sn">
      <variable>customers.lastName</variable>
    </at>
    <source name="customers">
      <source-name>customers</source-name>
      <field name="firstName">
        <expression>if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(0, i);</expression>
      </field>
      <field name="lastName">
        <expression>if (sn != void &amp;&amp; sn != null) return sn;
if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
return cn.substring(i+1);</expression>
      </field>
    </source>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="orders">
      <source-name>orders</source-name>
    </source>
    <relationship>
      <expression>products.id = order_details.productId</expression>
    </relationship>
    <relationship>
      <expression>order_details.orderId = orders.id</expression>
    </relationship>
    <relationship>
      <expression>orders.customer = customers.username</expression>
    </relationship>
  </entry>

  <entry dn="ou=Expensive Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Expensive Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Expensive Products,cn=...,ou=Categories,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
      <parameter>
        <param-name>filter</param-name>
        <param-value>(price&gt;=5.0)</param-value>
      </parameter>
    </source>
    <relationship>
      <expression>categories.id = products.categoryId</expression>
    </relationship>
  </entry>

  <entry dn="ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Customers</constant>
    </at>
  </entry>

  <entry dn="ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>All Customers</constant>
    </at>
  </entry>

  <entry dn="cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>customer</oc>
    <at name="cn" rdn="true">
      <expression>
if (customers == void || customers == null) return null;
if (customers.firstName == void || customers.firstName == null) return null;
if (customers.lastName == void || customers.lastName == null) return null;
return customers.firstName+" "+customers.lastName;
    </expression>
    </at>
    <at name="email">
      <variable>customer_emails.email</variable>
    </at>
    <at name="sn">
      <variable>customers.lastName</variable>
    </at>
    <at name="uid" rdn="true">
      <variable>customers.username</variable>
    </at>
    <at name="userPassword">
      <expression>import org.safehaus.penrose.util.*;

if (customers == void || customers == null) return null;
if (customers.encPassword == void || customers.encPassword == null) return null;

byte[] bytes = BinaryUtil.decode("BigInteger", customers.encPassword);
return "{SHA}"+BinaryUtil.encode("Base64", bytes);</expression>
    </at>
    <source name="customers">
      <source-name>customers</source-name>
      <field name="encPassword">
        <expression>import org.safehaus.penrose.util.*;

if (userPassword == void || userPassword == null) return null;

byte[] bytes;

String method = PasswordUtil.getEncryptionMethod(userPassword);
if (method == null) {
    bytes = PasswordUtil.encrypt("SHA", userPassword);

} else if ("SHA".equals(method)) {
    String password = PasswordUtil.getEncryptedPassword(userPassword);
    bytes = BinaryUtil.decode("Base64", password);

} else {
    throw new Exception("Unsupported encryption: "+method);
}

return BinaryUtil.encode("BigInteger", bytes);</expression>
      </field>
      <field name="firstName">
        <expression>if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(0, i);</expression>
      </field>
      <field name="lastName">
        <expression>if (sn != void &amp;&amp; sn != null) return sn;
if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(i+1);</expression>
      </field>
      <field name="username">
        <variable>uid</variable>
      </field>
    </source>
    <source name="customer_emails">
      <source-name>customer_emails</source-name>
      <field name="email">
        <variable>email</variable>
      </field>
    </source>
    <relationship>
      <expression>customers.username = customer_emails.username</expression>
    </relationship>
  </entry>

  <entry dn="ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Orders</constant>
    </at>
  </entry>

  <entry dn="orderId=...,ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>order</oc>
    <at name="date">
      <variable>orders.orderDate</variable>
    </at>
    <at name="orderId" rdn="true">
      <variable>orders.id</variable>
    </at>
    <source name="orders">
      <source-name>orders</source-name>
      <field name="id">
        <variable>orderId</variable>
      </field>
      <field name="orderDate">
        <variable>date</variable>
      </field>
    </source>
    <relationship>
      <expression>customers.username = orders.customer</expression>
    </relationship>
  </entry>

  <entry dn="ou=Products,orderId=...,ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Products,orderId=...,ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
      <field name="price">
        <variable>price</variable>
      </field>
    </source>
    <relationship>
      <expression>orders.id = order_details.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = products.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Categories,cn=...,ou=Products,orderId=...,ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Categories</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Categories,cn=...,ou=Products,orderId=...,ou=Orders,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>category</oc>
    <at name="cn" rdn="true">
      <variable>categories.name</variable>
    </at>
    <at name="description">
      <variable>categories.description</variable>
    </at>
    <source name="categories">
      <source-name>categories</source-name>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <relationship>
      <expression>products.categoryId = categories.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Products,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Products,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="price">
      <variable>products.price</variable>
    </at>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="orders">
      <source-name>orders</source-name>
    </source>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
      <field name="price">
        <variable>price</variable>
      </field>
    </source>
    <relationship>
      <expression>orders.id = order_details.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = products.id</expression>
    </relationship>
    <relationship>
      <expression>customers.username = orders.customer</expression>
    </relationship>
  </entry>

  <entry dn="ou=Categories,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Categories</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Categories,cn=...+uid=...,ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>category</oc>
    <at name="cn" rdn="true">
      <variable>categories.name</variable>
    </at>
    <at name="description">
      <variable>categories.description</variable>
    </at>
    <source name="categories">
      <source-name>categories</source-name>
      <field name="description">
        <variable>description</variable>
      </field>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="orders">
      <source-name>orders</source-name>
    </source>
    <source name="products">
      <source-name>products</source-name>
    </source>
    <relationship>
      <expression>orders.id = order_details.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = products.id</expression>
    </relationship>
    <relationship>
      <expression>products.categoryId = categories.id</expression>
    </relationship>
    <relationship>
      <expression>customers.username = orders.customer</expression>
    </relationship>
  </entry>

  <entry dn="ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Families</constant>
    </at>
  </entry>

  <entry dn="sn=...,ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>family</oc>
    <at name="description">
      <expression>
if (customers == void || customers == null || customers.firstName == void || customers.firstName == null) {
    return "no members";
} else if (customers.firstName instanceof Collection) {
    return customers.firstName.size()+" members";
} else {
    return "1 member";
}</expression>
    </at>
    <at name="sn" rdn="true">
      <variable>customers.lastName</variable>
    </at>
    <at name="uniqueMember">
      <expression foreach="customers.firstName" var="x">"cn="+x+" "+customers.lastName+",ou=Customers,dc=Shop,dc=Example,dc=com"</expression>
    </at>
    <source name="customers">
      <source-name>customers</source-name>
      <field name="firstName">
        <expression foreach="uniqueMember" var="x">int i = x.indexOf("=");
int j = x.indexOf(",");
return x.substring(i+1, j);</expression>
      </field>
      <field name="lastName">
        <variable>sn</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Members,sn=...,ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Members</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Members,sn=...,ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>customer</oc>
    <at name="cn" rdn="true">
      <expression>
if (customers2 == void || customers2 == void) return null;
if (customers2.firstName == void || customers2.firstName == void) return null;
if (customers2.lastName == void || customers2.lastName == void) return null;
return customers2.firstName+" "+customers2.lastName;
      </expression>
    </at>
    <at name="sn">
      <variable>customers2.lastName</variable>
    </at>
    <at name="uid">
      <variable>customers2.username</variable>
    </at>
    <at name="userPassword">
      <variable>customers2.password</variable>
    </at>
    <source name="customers2">
      <source-name>customers</source-name>
      <field name="firstName">
        <expression>if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(0, i);</expression>
      </field>
      <field name="lastName">
        <expression>if (sn != void &amp;&amp; sn != null) return sn;
if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(i+1);</expression>
      </field>
      <field name="password">
        <variable>userPassword</variable>
      </field>
      <field name="username">
        <variable>uid</variable>
      </field>
    </source>
    <relationship>
      <expression>customers.lastName = customers2.lastName</expression>
    </relationship>
  </entry>

  <entry dn="ou=Orders,sn=...,ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Orders</constant>
    </at>
  </entry>

  <entry dn="orderId=...,ou=Orders,sn=...,ou=Families,ou=Customers,dc=Shop,dc=Example,dc=com">
    <oc>order</oc>
    <at name="date">
      <variable>orders.orderDate</variable>
    </at>
    <at name="orderId" rdn="true">
      <variable>orders.id</variable>
    </at>
    <at name="uid">
      <variable>orders.customer</variable>
    </at>
    <source name="customers2">
      <source-name>customers</source-name>
    </source>
    <source name="orders">
      <source-name>orders</source-name>
      <field name="customer">
        <variable>uid</variable>
      </field>
      <field name="id">
        <variable>orderId</variable>
      </field>
      <field name="orderDate">
        <variable>date</variable>
      </field>
    </source>
    <relationship>
      <expression>customers.lastName = customers2.lastName</expression>
    </relationship>
    <relationship>
      <expression>customers2.username = orders.customer</expression>
    </relationship>
  </entry>

  <entry dn="ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Orders</constant>
    </at>
  </entry>

  <entry dn="ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>All Orders</constant>
    </at>
  </entry>

  <entry dn="orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>order</oc>
    <at name="date">
      <variable>orders.orderDate</variable>
    </at>
    <at name="orderId" rdn="true">
      <variable>orders.id</variable>
    </at>
    <source name="orders">
      <source-name>orders</source-name>
      <field name="id">
        <variable>orderId</variable>
      </field>
      <field name="orderDate">
        <variable>date</variable>
      </field>
    </source>
  </entry>

  <entry dn="ou=Products,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Products</constant>
    </at>
  </entry>

  <entry dn="cn=...,ou=Products,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>product</oc>
    <at name="cn" rdn="true">
      <variable>products.name</variable>
    </at>
    <at name="description">
      <variable>categories.name</variable>
    </at>
    <source name="products">
      <source-name>products</source-name>
      <field name="name">
        <variable>cn</variable>
      </field>
    </source>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="categories">
      <source-name>categories</source-name>
    </source>
    <relationship>
      <expression>orders.id = order_details.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = products.id</expression>
    </relationship>
    <relationship>
      <expression>products.categoryId = categories.id</expression>
    </relationship>
  </entry>

  <entry dn="ou=Histories,cn=...,ou=Products,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Histories</constant>
    </at>
  </entry>

  <entry dn="date=...,ou=Histories,cn=...,ou=Products,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>orderDetail</oc>
    <at name="date" rdn="true">
      <variable>order_histories.historyDate</variable>
    </at>
    <at name="description">
      <variable>order_histories.description</variable>
    </at>
    <at name="orderId">
      <variable>order_histories.orderId</variable>
    </at>
    <at name="productId">
      <variable>order_histories.productId</variable>
    </at>
    <source name="order_histories">
      <source-name>order_histories</source-name>
    </source>
    <relationship>
      <expression>order_details.orderId = order_histories.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = order_histories.productId</expression>
    </relationship>
  </entry>

  <entry dn="ou=Histories,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Histories</constant>
    </at>
  </entry>

  <entry dn="date=...+productId=...,ou=Histories,orderId=...,ou=All Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>orderDetail</oc>
    <at name="date" rdn="true">
      <variable>order_histories.historyDate</variable>
    </at>
    <at name="productId" rdn="true">
      <variable>order_histories.productId</variable>
    </at>
    <source name="order_details">
      <source-name>order_details</source-name>
    </source>
    <source name="order_histories">
      <source-name>order_histories</source-name>
    </source>
    <relationship>
      <expression>orders.id = order_details.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.orderId = order_histories.orderId</expression>
    </relationship>
    <relationship>
      <expression>order_details.productId = order_histories.productId</expression>
    </relationship>
  </entry>

  <entry dn="ou=Recent Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Recent Orders</constant>
    </at>
  </entry>
  <entry dn="orderId=...,ou=Recent Orders,ou=Orders,dc=Shop,dc=Example,dc=com">
    <oc>order</oc>
    <at name="date">
      <variable>orders.orderDate</variable>
    </at>
    <at name="orderId" rdn="true">
      <variable>orders.id</variable>
    </at>
    <source name="orders">
      <source-name>orders</source-name>
      <field name="id">
        <variable>orderId</variable>
      </field>
      <field name="orderDate">
        <variable>date</variable>
      </field>
      <parameter>
        <param-name>filter</param-name>
        <param-value>(orderDate&gt;=2005-06-01)</param-value>
      </parameter>
    </source>
  </entry>

  <entry dn="ou=Employees,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Employees</constant>
    </at>
  </entry>

  <entry dn="ou=All Employees,ou=Employees,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>All Employees</constant>
    </at>
  </entry>

  <entry dn="uid=...,ou=All Employees,ou=Employees,dc=Shop,dc=Example,dc=com">
    <oc>customer</oc>
    <at name="cn">
      <expression>
if (employees == void || employees == null) return null;
if (employees.firstName == void || employees.firstName == null) return null;
if (employees.lastName == void || employees.lastName == null) return null;
return employees.firstName+" "+employees.lastName;
    </expression>
    </at>
    <at name="sn">
      <variable>employees.lastName</variable>
    </at>
    <at name="uid" rdn="true">
      <variable>employees.username</variable>
    </at>
    <at name="userPassword">
      <expression>import org.safehaus.penrose.util.*;

if (employees == void || employees == null) return null;
if (employees.encPassword == void || employees.encPassword == null) return null;

byte[] bytes = BinaryUtil.decode("BigInteger", employees.encPassword);
return "{SHA}"+BinaryUtil.encode("Base64", bytes);</expression>
    </at>
    <source name="employees">
      <source-name>employees</source-name>
      <field name="encPassword">
        <expression>import org.safehaus.penrose.util.*;

if (userPassword == void || userPassword == null) return null;

byte[] bytes;

String method = PasswordUtil.getEncryptionMethod(userPassword);
if (method == null) {
    bytes = PasswordUtil.encrypt("SHA", userPassword);

} else if ("SHA".equals(method)) {
    String password = PasswordUtil.getEncryptedPassword(userPassword);
    bytes = BinaryUtil.decode("Base64", password);

} else {
    throw new Exception("Unsupported encryption: "+method);
}

return BinaryUtil.encode("BigInteger", bytes);</expression>
      </field>
      <field name="firstName">
        <expression>if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(0, i);</expression>
      </field>
      <field name="lastName">
        <expression>if (sn != void &amp;&amp; sn != null) return sn;
if (cn == void || cn == null) return null;
int i = cn.indexOf(" ");
if (i &lt; 0) return null;
return cn.substring(i+1);</expression>
      </field>
      <field name="username">
        <variable>uid</variable>
      </field>
    </source>
    <aci subject="self">
      <permission>rsw</permission>
    </aci>
  </entry>

  <entry dn="ou=Groups,dc=Shop,dc=Example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <constant>Groups</constant>
    </at>
  </entry>

  <entry dn="cn=Employees,ou=Groups,dc=Shop,dc=Example,dc=com">
    <oc>groupOfUniqueNames</oc>
    <at name="cn" rdn="true">
      <constant>Employees</constant>
    </at>
    <at name="uniqueMember">
      <expression foreach="employees.username" var="username">"uid="+username+",ou=All Employees,ou=Employees,dc=Shop,dc=Example,dc=com"</expression>
    </at>
    <source name="employees">
      <source-name>employees</source-name>
      <field name="username">
        <expression foreach="uniqueMember" var="x">int i = x.indexOf("=");
int j = x.indexOf(",");
return x.substring(i+1, j);</expression>
      </field>
    </source>
  </entry>

  <entry dn="cn=Customers,ou=Groups,dc=Shop,dc=Example,dc=com">
    <oc>groupOfUniqueNames</oc>
    <at name="cn" rdn="true">
      <constant>Customers</constant>
    </at>
    <at name="uniqueMember">
      <expression foreach="customers.username" var="username">"uid="+username+",ou=All Customers,ou=Customers,dc=Shop,dc=Example,dc=com"</expression>
    </at>
    <source name="customers">
      <source-name>customers</source-name>
      <field name="username">
        <expression foreach="uniqueMember" var="x">int i = x.indexOf("=");
int j = x.indexOf(",");
return x.substring(i+1, j);</expression>
      </field>
    </source>
  </entry>
    
</mapping>
