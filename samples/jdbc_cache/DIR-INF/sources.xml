<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sources PUBLIC
  "-//Penrose/DTD Sources ${product.specification}//EN"
  "http://penrose.safehaus.org/dtd/sources.dtd">

<sources>

  <source name="orig_users">
    <connection-name>MySQL</connection-name>
    <field name="username" primaryKey="true">
      <variable>cache_users.uid</variable>
    </field>
    <field name="firstName">
      <expression>
if (cache_users.cn == void || cache_users.cn == null) return null;
int i = cache_users.cn.lastIndexOf(" ");
if (i &lt; 0) return null;
return cache_users.cn.substring(0, i);
      </expression>
    </field>
    <field name="lastName">
      <expression>
if (cache_users.sn != void &amp;&amp; cache_users.sn != null) return cache_users.sn;
if (cache_users.cn == void || cache_users.cn == null) return null;
int i = cache_users.cn.lastIndexOf(" ");
if (i &lt; 0) return cache_users.cn;
return cache_users.cn.substring(i+1);
      </expression>
    </field>
    <field name="password">
      <variable>cache_users.userPassword</variable>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>users</param-value>
    </parameter>
  </source>

  <source name="orig_groups">
    <connection-name>MySQL</connection-name>
    <field name="groupname" primaryKey="true">
      <variable>cache_groups.cn</variable>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>groups</param-value>
    </parameter>
  </source>

  <source name="orig_usergroups">
    <connection-name>MySQL</connection-name>
    <field name="groupname" primaryKey="true">
      <variable>orig_groups.groupname</variable>
    </field>
    <field name="username" primaryKey="true">
      <expression foreach="cache_usergroups.uniqueMember" var="um">
int i=um.indexOf("=");
int j=um.indexOf(",");
return um.substring(i+1, j);
      </expression>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>usergroups</param-value>
    </parameter>
  </source>

  <source name="cache_users">
    <connection-name>Cache</connection-name>
    <field name="uid" primaryKey="true">
      <variable>orig_users.username</variable>
    </field>
    <field name="cn">
      <expression>
if (orig_users == void || orig_users == null) return null;
return orig_users.firstName+" "+orig_users.lastName;
      </expression>
    </field>
    <field name="sn">
      <variable>orig_users.lastName</variable>
    </field>
    <field name="userPassword">
      <variable>orig_users.password</variable>
    </field>
    <parameter>
      <param-name>baseDn</param-name>
      <param-value>ou=Users,dc=JDBC Cache,dc=Example,dc=com</param-value>
    </parameter>
    <parameter>
      <param-name>table</param-name>
      <param-value>users</param-value>
    </parameter>
  </source>

  <source name="cache_groups">
    <connection-name>Cache</connection-name>
    <field name="cn" primaryKey="true">
      <variable>orig_groups.groupname</variable>
    </field>
    <parameter>
      <param-name>baseDn</param-name>
      <param-value>ou=Groups,dc=JDBC Cache,dc=Example,dc=com</param-value>
    </parameter>
    <parameter>
      <param-name>table</param-name>
      <param-value>groups</param-value>
    </parameter>
  </source>

  <source name="cache_usergroups">
    <connection-name>Cache</connection-name>
    <field name="cn" primaryKey="true">
      <variable>cache_groups.cn</variable>
    </field>
    <field name="uniqueMember" primaryKey="true" length="200">
      <expression foreach="orig_usergroups.username" var="username">
return "uid="+username+",ou=Users,dc=JDBC Cache,dc=Example,dc=com";
      </expression>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>usergroups</param-value>
    </parameter>
  </source>

  <source name="changelog">
    <connection-name>ChangeLog</connection-name>
    <field name="changeNumber" type="INTEGER" primaryKey="true" autoIncrement="true"/>
    <field name="targetDN" type="TEXT"/>
    <field name="changeType" type="VARCHAR" length="255"/>
    <field name="changes" type="TEXT"/>
    <field name="newRDN" type="TEXT"/>
    <field name="deleteOldRDN" type="BOOLEAN"/>
    <field name="newSuperior" type="TEXT"/>
    <parameter>
      <param-name>table</param-name>
      <param-value>changelog</param-value>
    </parameter>
  </source>

</sources>
