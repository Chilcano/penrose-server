<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sources PUBLIC
  "-//Penrose/DTD Sources ${product.specification}//EN"
  "http://penrose.safehaus.org/dtd/sources.dtd">

<sources>

  <source name="users">
    <connection-name>OpenLDAP</connection-name>
    <field name="uid" primaryKey="true"/>
    <field name="cn"/>
    <field name="sn"/>
    <field name="userPassword"/>
    <parameter>
      <param-name>baseDn</param-name>
      <param-value>ou=Users,dc=my-domain,dc=com</param-value>
    </parameter>
    <parameter>
      <param-name>scope</param-name>
      <param-value>ONELEVEL</param-value>
    </parameter>
    <parameter>
      <param-name>filter</param-name>
      <param-value>(objectClass=*)</param-value>
    </parameter>
    <parameter>
      <param-name>objectClasses</param-name>
      <param-value>person,organizationalPerson,inetOrgPerson</param-value>
    </parameter>
  </source>

  <source name="users_cache">
    <connection-name>Cache</connection-name>
    <field name="username" primaryKey="true">
      <variable>users.uid</variable>
    </field>
    <field name="firstName">
      <expression>
if (users == void || users == null) return null;
if (users.cn == void || users.cn == null) return null;
int i = users.cn.lastIndexOf(" ");
return users.cn.substring(0, i);
      </expression>
    </field>
    <field name="lastName">
      <expression>
if (users == void || users == null) return null;
if (users.sn != void &amp;&amp; users.sn != null) return users.sn;
if (users.cn == void || users.cn == null) return null;
int i = users.cn.lastIndexOf(" ");
return users.cn.substring(i+1);
      </expression>
    </field>
    <field name="password">
      <variable>users.userPassword</variable>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>users_cache</param-value>
    </parameter>
  </source>

  <source name="groups">
    <connection-name>OpenLDAP</connection-name>
    <field name="cn" primaryKey="true"/>
    <field name="uniqueMember"/>
    <parameter>
      <param-name>baseDn</param-name>
      <param-value>ou=Groups,dc=my-domain,dc=com</param-value>
    </parameter>
    <parameter>
      <param-name>scope</param-name>
      <param-value>ONELEVEL</param-value>
    </parameter>
    <parameter>
      <param-name>filter</param-name>
      <param-value>(objectClass=*)</param-value>
    </parameter>
    <parameter>
      <param-name>objectClasses</param-name>
      <param-value>groupOfUniqueNames</param-value>
    </parameter>
  </source>

  <source name="groups_cache">
    <connection-name>Cache</connection-name>
    <field name="groupname" primaryKey="true">
      <variable>groups.cn</variable>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>groups_cache</param-value>
    </parameter>
  </source>

  <source name="usergroups_cache">
    <connection-name>Cache</connection-name>
    <field name="groupname" primaryKey="true">
      <variable>groups.cn</variable>
    </field>
    <field name="username" primaryKey="true">
      <expression foreach="groups.uniqueMember" var="um">
int i=um.indexOf("=");
int j=um.indexOf(",");
return um.substring(i+1, j);
      </expression>
    </field>
    <parameter>
      <param-name>table</param-name>
      <param-value>usergroups_cache</param-value>
    </parameter>
  </source>

  <source-sync name="users">
    <class-name>org.safehaus.penrose.source.ldap.LDAPSourceSync</class-name>
    <parameter>
      <param-name>source</param-name>
      <param-value>users</param-value>
    </parameter>
  </source-sync>

  <source-sync name="groups">
    <class-name>org.safehaus.penrose.source.ldap.LDAPSourceSync</class-name>
    <parameter>
      <param-name>source</param-name>
      <param-value>groups</param-value>
    </parameter>
  </source-sync>

</sources>
