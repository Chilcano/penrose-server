<?xml version="1.0" encoding="UTF-8"?>
<!--
<!DOCTYPE mapping PUBLIC 
	"-//Penrose/Penrose Server Configuration DTD 1.0//EN" 
	"http://penrose.safehaus.org/dtd/penrose-mapping-config-1.0.dtd">
-->

<mapping>

  <entry dn="dc=example,dc=com">
    <oc>dcObject</oc>
    <oc>organization</oc>
    <at name="dc" rdn="true">
      <expression>"example"</expression>
    </at>
    <at name="o">
      <expression>"example"</expression>
    </at>
  </entry>

  <entry dn="cn=manager,dc=example,dc=com">
    <oc>person</oc>
    <oc>inetOrgPerson</oc>
    <at name="cn" rdn="true">
      <expression>"manager"</expression>
    </at>
    <at name="sn">
      <expression>"manager"</expression>
    </at>
    <at name="userPassword">
      <expression>"secret"</expression>
    </at>
  </entry>

  <entry dn="ou=users,dc=example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <expression>"users"</expression>
    </at>
  </entry>

  <entry dn="uid=...,ou=users,dc=example,dc=com">
    <oc>person</oc>
    <oc>inetOrgPerson</oc>
    <at name="uid" rdn="true">
      <expression>u.username</expression>
    </at>
    <at name="cn">
      <expression>u.firstName+" "+u.lastName</expression>
    </at>
    <at name="sn">
      <expression>u.lastName</expression>
    </at>
    <at name="userPassword">
      <expression>u.password</expression>
    </at>
    <source name="u">
      <source-name>users</source-name>
      <connection-name>MySQL</connection-name>
      <field name="username">
        <expression>uid</expression>
      </field>
      <field name="firstName">
        <expression>
if (cn == void || cn == null) return null;
int i = cn.lastIndexOf(" ");
return cn.substring(0, i);
        </expression>
      </field>
      <field name="lastName">
        <expression>
if (cn == void || cn == null) return null;
int i = cn.lastIndexOf(" ");
return cn.substring(i+1);
        </expression>
      </field>
      <field name="password">
        <expression>userPassword</expression>
      </field>
    </source>
  </entry>

  <entry dn="cn=...,uid=...,ou=users,dc=example,dc=com">
    <oc>groupOfUniqueNames</oc>
    <at name="cn" rdn="true">
      <expression>g.groupname</expression>
    </at>
    <at name="description" rdn="false">
      <expression>g.description</expression>
    </at>
    <at name="uniqueMember" rdn="false">
      <expression>
if (ug2 == void || ug2 == null) return null;
return "uid="+ug2.username+",ou=users,dc=example,dc=com";
      </expression>
    </at>
    <source name="ug">
      <source-name>usergroups</source-name>
      <connection-name>MySQL</connection-name>
    </source>
    <source name="g">
      <source-name>groups</source-name>
      <connection-name>MySQL</connection-name>
      <field name="description">
        <expression>description</expression>
      </field>
      <field name="groupname">
        <expression>cn</expression>
      </field>
    </source>
    <source name="ug2">
      <source-name>usergroups</source-name>
      <connection-name>MySQL</connection-name>
      <field name="groupname">
        <expression>cn</expression>
      </field>
      <field name="username">
        <expression>
if (uniqueMember == void || uniqueMember == null) return null;
int i = uniqueMember.indexOf("=");
int j = uniqueMember.indexOf(",", i+1);
return uniqueMember.substring(i+1, j);
        </expression>
      </field>
    </source>
    <relationship>
      <expression>u.username = ug.username</expression>
    </relationship>
    <relationship>
      <expression>g.groupname = ug.groupname</expression>
    </relationship>
    <relationship>
      <expression>g.groupname = ug2.groupname</expression>
    </relationship>
  </entry>

  <entry dn="ou=groups,dc=example,dc=com">
    <oc>organizationalUnit</oc>
    <at name="ou" rdn="true">
      <expression>"groups"</expression>
    </at>
  </entry>

  <entry dn="cn=...,ou=groups,dc=example,dc=com">
    <oc>groupOfUniqueNames</oc>
    <at name="cn" rdn="true">
      <expression>g.groupname</expression>
    </at>
    <at name="description">
      <expression>g.description</expression>
    </at>
    <at name="uniqueMember">
      <expression>
if (ug == void || ug == null) return null;
return "uid="+ug.username+",ou=users,dc=example,dc=com";
      </expression>
    </at>
    <source name="g">
      <source-name>groups</source-name>
      <connection-name>MySQL</connection-name>
      <field name="groupname">
        <expression>cn</expression>
      </field>
      <field name="description">
        <expression>description</expression>
      </field>
    </source>
    <source name="ug">
      <source-name>usergroups</source-name>
      <connection-name>MySQL</connection-name>
      <field name="groupname">
        <expression>cn</expression>
      </field>
      <field name="username">
        <expression>
if (uniqueMember == void || uniqueMember == null) return null;
int i = uniqueMember.indexOf("=");
int j = uniqueMember.indexOf(",", i+1);
return uniqueMember.substring(i+1, j);
        </expression>
      </field>
    </source>
    <relationship>
      <expression>g.groupname = ug.groupname</expression>
    </relationship>
  </entry>

  <entry dn="uid=...,cn=...,ou=groups,dc=example,dc=com">
    <oc>person</oc>
    <oc>inetOrgPerson</oc>
    <at name="uid" rdn="true">
      <expression>u.username</expression>
    </at>
    <at name="cn">
      <expression>u.firstName+" "+u.lastName</expression>
    </at>
    <at name="sn">
      <expression>u.lastName</expression>
    </at>
    <at name="userPassword">
      <expression>u.password</expression>
    </at>
    <source name="u">
      <source-name>users</source-name>
      <connection-name>MySQL</connection-name>
      <field name="username">
        <expression>uid</expression>
      </field>
      <field name="firstName">
        <expression>
if (cn == void || cn == null) return null;
int i = cn.lastIndexOf(" ");
return cn.substring(0, i);
        </expression>
      </field>
      <field name="lastName">
        <expression>
if (cn == void || cn == null) return null;
int i = cn.lastIndexOf(" ");
return cn.substring(i+1);
        </expression>
      </field>
      <field name="password">
        <expression>userPassword</expression>
      </field>
    </source>
    <relationship>
      <expression>ug.username = u.username</expression>
    </relationship>
  </entry>

</mapping>
