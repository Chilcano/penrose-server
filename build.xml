<!--
 Copyright (c) 2000-2005, Identyx Corporation.
 All rights reserved.
-->
<project name="penrose" default="build" basedir=".">

    <description>Penrose</description>

    <property name="project.name" value="penrose"/>
    <property name="project.version" value="1.1"/>
    <property name="project.dist" value="dist"/>
    <property name="prefix" value=""/>
    <property name="penrose.home" value="${prefix}/usr/local/penrose"/>
    <property name="iscc.path" value="ISCC.exe"/>
    <property name="docs.target" value="${project.dist}/javadoc"/>

    <tstamp/>

    <path id="lib.path">
        <fileset dir="lib">
            <include name="**/*.jar"/>
        </fileset>
        <pathelement location="lib/"/>
    </path>

    <path id="main.path">
        <pathelement location="target/classes"/>
    </path>

    <path id="project.classpath">
        <fileset dir="svnant">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <taskdef resource="svntask.properties" classpathref="project.classpath"/>

    <target name="build-ant">
        <mkdir dir="target/ant"/>
        <javac srcdir="src/ant" destdir="target/ant"/>
        <jar destfile="target/penrose-ant.jar" basedir="target/ant"/>
    </target>

    <target name="build">
        <javacc
            target="src/java/org/safehaus/penrose/schema/LDAPv3Schema.jj"
            javacchome="lib/javacc"
            outputdirectory="src/java/org/safehaus/penrose/schema"
        />
        <javacc
            target="src/java/org/safehaus/penrose/filter/item/ItemParser.jj"
            javacchome="lib/javacc"
            outputdirectory="src/java/org/safehaus/penrose/filter/item"
        />
        <javacc
            target="src/java/org/safehaus/penrose/filter/FilterParser.jj"
            javacchome="lib/javacc"
            outputdirectory="src/java/org/safehaus/penrose/filter"
        />
        <javacc
            target="src/java/org/safehaus/penrose/openldap/config/SlapdParser.jj"
            javacchome="lib/javacc"
            outputdirectory="src/java/org/safehaus/penrose/openldap/config"
        />
        <javacc
            target="src/java/org/safehaus/penrose/sql/SQLParser.jj"
            javacchome="lib/javacc"
            outputdirectory="src/java/org/safehaus/penrose/sql"
        />
        <mkdir dir="target/classes"/>
        <javac
            srcdir="src/java"
            destdir="target/classes"
            classpathref="lib.path"
            debug="on"
            debuglevel="lines,vars,source"
            source="1.4"
            target="1.4"
        />
        <copy todir="target/classes">
            <fileset dir="src/java" includes="**/*.xml"/>
        </copy>
        <jar jarfile="target/${project.name}-${project.version}.jar">
            <fileset dir="target/classes"/>
            <manifest>
              <attribute name="Specification-Version"  value="1.0"/>
              <attribute name="Implementation-Title"   value="Penrose Virtual Directory Server"/>
              <attribute name="Implementation-Version" value="${project.version}"/>
              <attribute name="Implementation-Vendor"  value="Identyx Corporation"/>
              <attribute name="Built-Date" value="${DSTAMP}"/>
            </manifest>
        </jar>
    </target>

    <target name="docs" depends="build">
        <mkdir dir="target/javadoc"/>
        <javadoc packagenames="org.safehaus.penrose.*"
            sourcepath="src/java"
            destdir="target/javadoc"
            classpathref="lib.path">
        </javadoc>
        <jar jarfile="target/${project.name}-docs-${project.version}.jar">
            <fileset dir="target/javadoc"/>
        </jar>
    </target>

    <target name="docs-publish">
        <delete dir="${docs.target}"/>
        <mkdir dir="${docs.target}"/>
        <copy todir="${docs.target}" overwrite="true">
            <fileset dir="target/javadoc" includes="**/*"/>
        </copy>
    </target>

    <target name="dist" depends="build-ant,build">
        <mkdir dir="target/dist"/>
        <copy todir="target/dist" file="README.txt">
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <copy todir="target/dist" file="LICENSE.txt"/>
        <copy todir="target/dist" file="COPYING.txt"/>
        <copy todir="target/dist" file="INSTALL-BINARY.txt">
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <copy todir="target/dist" file="pom.xml"/>
        <copy todir="target/dist/etc">
            <fileset dir="etc" includes="**/*"/>
        </copy>
        <chmod file="target/dist/etc/init.d/penrose" perm="ugo+rx"/>
        <copy todir="target/dist/docs">
            <fileset dir="docs" includes="*.url"/>
        </copy>
        <copy todir="target/dist/docs/javadoc" failonerror="false">
            <fileset dir="target/javadoc"/>
        </copy>
        <copy todir="target/dist/lib" includeEmptyDirs="false">
            <fileset dir="lib" includes="*"/>
        </copy>
        <copy todir="target/dist/lib"
            file="target/${project.name}-${project.version}.jar">
        </copy>
        <mkdir dir="target/dist/lib/ext"/>
        <copy todir="target/dist/conf/default">
            <fileset dir="conf"/>
        </copy>
        <taskdef name="wrapper" classname="org.safehaus.penrose.ant.WrapperTask" classpath="target/penrose-ant.jar"/>
        <wrapper file="target/dist/conf/default/wrapper.conf" dir="lib"/>
        <copy todir="target/dist/conf">
            <fileset dir="target/dist/conf/default"/>
        </copy>
        <copy todir="target/dist/schema">
            <fileset dir="schema"/>
        </copy>
        <copy todir="target/dist/jboss">
            <fileset dir="jboss"/>
        </copy>
        <copy todir="target/dist"
            file="images/penrose.ico">
        </copy>
        <copy todir="target/dist/bin">
            <fileset dir="bin"/>
        </copy>
        <fixcrlf
            srcdir="target/dist/bin"
            includes="**/*.sh"
            eol="unix"
        />
        <chmod dir="target/dist/bin" perm="ugo+rx" includes="**/*.sh"/>
        <copy todir="target/dist/samples">
            <fileset dir="samples"/>
        </copy>
        <mkdir dir="target/dist/partitions"/>
        <mkdir dir="target/dist/var"/>
    </target>

    <target name="dist-jboss" depends="build">
        <mkdir dir="target/nlog4j"/>
        <unjar src="lib/nlog4j-1.2.17.jar" dest="target/nlog4j">
            <patternset excludes="META-INF/MANIFEST.MF"/>
        </unjar>
        <jar jarfile="target/${project.name}-jboss-${project.version}.jar">
            <fileset dir="target/classes"/>
            <fileset dir="target/nlog4j"/>
        </jar>
        <mkdir dir="target/penrose.sar"/>
        <copy todir="target/penrose.sar" includeEmptyDirs="false">
            <fileset dir="lib" includes="*"/>
        </copy>
        <copy todir="target/penrose.sar"
            file="target/${project.name}-jboss-${project.version}.jar">
        </copy>
        <mkdir dir="target/penrose.sar/META-INF"/>
        <copy todir="target/penrose.sar/META-INF">
            <fileset file="conf/jboss/jboss-service.xml"/>
        </copy>
        <copy todir="target/penrose.sar/conf" includeEmptyDirs="false">
            <fileset dir="conf" includes="*" />
        </copy>
        <jar basedir="target/penrose.sar" jarfile="target/${project.name}-${project.version}.sar"/>
    </target>

    <target name="dist-src" depends="docs,dist">
        <echo message="Creating ${project.name}-${project.version}-src.zip"/>
        <mkdir dir="${project.dist}"/>
        <zip destfile="${project.dist}/${project.name}-${project.version}-src.zip">
            <zipfileset dir=".">
                <exclude name="${project.dist}/**"/>
                <exclude name="target/**"/>
            </zipfileset>
        </zip>
        <echo message="Creating ${project.name}-${project.version}-src.tar.gz"/>
        <mkdir dir="target"/>
        <tar destfile="target/${project.name}-${project.version}-src.tar">
            <tarfileset dir="." prefix="${project.name}-${project.version}">
                <exclude name="${project.dist}/**"/>
                <exclude name="target/**"/>
            </tarfileset>
        </tar>
        <gzip destfile="${project.dist}/${project.name}-${project.version}-src.tar.gz"
            src="target/${project.name}-${project.version}-src.tar"/>
    </target>

    <target name="dist-unix" depends="docs,dist">
        <echo message="Creating ${project.name}-${project.version}.zip"/>
        <mkdir dir="${project.dist}"/>
        <zip destfile="${project.dist}/${project.name}-${project.version}.zip"
            basedir="target/dist"/>
        <echo message="Creating ${project.name}-${project.version}.tar.gz"/>
        <mkdir dir="target"/>
        <tar destfile="target/${project.name}-${project.version}.tar">
            <tarfileset dir="target/dist" prefix="${project.name}-${project.version}" mode="755">
                <include name="bin/*.sh"/>
            </tarfileset>
            <tarfileset dir="target/dist" prefix="${project.name}-${project.version}">
                <include name="**/*"/>
                <exclude name="bin/*.sh"/>
            </tarfileset>
        </tar>
        <gzip destfile="${project.dist}/${project.name}-${project.version}.tar.gz"
            src="target/${project.name}-${project.version}.tar"/>
    </target>

    <target name="dist-rpm" depends="dist-src">
        <copy todir="target" file="rpm/penrose.spec">
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <copy todir="/usr/src/redhat/SOURCES" overwrite="true"
            file="${project.dist}/${project.name}-${project.version}-src.tar.gz">
        </copy>
        <exec executable="/usr/bin/rpmbuild" os="Linux">
            <arg line="-ba target/penrose.spec"/>
        </exec>
        <copy todir="${project.dist}" failonerror="false"
            file="/usr/src/redhat/SRPMS/${project.name}-${project.version}-1.src.rpm">
        </copy>
        <copy todir="${project.dist}" failonerror="false"
            file="/usr/src/redhat/RPMS/i386/${project.name}-${project.version}-1.i386.rpm">
        </copy>
    </target>

    <target name="dist-win32" depends="docs,dist">
        <echo message="Creating ${project.name}-server-${project.version}.exe"/>
        <copy todir="target" file="penrose.iss">
            <filterchain>
                <expandproperties/>
            </filterchain>
        </copy>
        <mkdir dir="${project.dist}"/>
        <exec executable="${iscc.path}" os="Windows NT,Windows 2000,Windows XP,Windows 2003">
            <arg line="/Q target/penrose.iss"/>
        </exec>
    </target>

    <target name="dist-all" depends="dist-src,dist-unix,dist-win32">
        <copy todir="${project.dist}"
            file="target/${project.name}-${project.version}.jar">
        </copy>
    </target>

    <target name="pre-install">
        <mkdir dir="${penrose.home}"/>
        <condition property="penrose.conf.missing">
          <not>
            <available file="${penrose.home}/conf/server.xml"/>
          </not>
        </condition>
    </target>

    <target name="copy-penrose-conf" if="penrose.conf.missing">
        <copy todir="${penrose.home}">
            <fileset dir="target/dist">
                <include name="conf/**/*"/>
            </fileset>
        </copy>
    </target>

    <target name="install" depends="pre-install,copy-penrose-conf">
        <copy todir="${penrose.home}">
            <fileset dir="target/dist">
                <include name="**/*"/>
                <exclude name="conf/**/*"/>
            </fileset>
        </copy>
        <chmod dir="${penrose.home}/bin" perm="ugo+rx" includes="**/*.sh"/>
        <copy todir="${prefix}/etc/init.d"
            file="target/dist/etc/init.d/penrose"/>
        <chmod file="${prefix}/etc/init.d/penrose" perm="ugo+rx"/>
    </target>

    <target name="uninstall">
        <delete failonerror="false" includeemptydirs="true">
            <fileset dir="${penrose.home}/bin" includes="**/*"/>
            <fileset dir="${penrose.home}/conf/default" includes="*"/>
            <fileset dir="${penrose.home}/docs" includes="**/*"/>
            <fileset dir="${penrose.home}/lib" includes="*"/>
            <fileset dir="${penrose.home}/samples" includes="**/*"/>
            <fileset dir="${penrose.home}/schema" includes="**/*"/>
            <fileset dir="${penrose.home}" includes="*"/>
            <fileset dir="${prefix}/etc/init.d" includes="penrose"/>
        </delete>
    </target>

    <target name="clean">
        <delete dir="dist" failonerror="false"/>
        <delete dir="target" failonerror="false"/>
    </target>

    <target name="update">
        <svn>
            <update dir="."/>
        </svn> 
    </target>

</project>
